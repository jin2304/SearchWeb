<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Searchweb</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="your-custom-styles.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<style>
    body {
        background-color: #f8fafc;
        font-family: 'Inter', sans-serif;
    }

    .mainContainer {
        max-width: 1400px;
        margin: 0 auto;
    }


    .website-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        overflow: hidden;
        height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .website-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .website-card-header {
        display: flex;
        align-items: center;
        padding: 16px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .website-card-body {
        padding: 16px;
        position: relative;
        flex-grow: 1;
    }

    .website-icon {
        width: 40px;
        height: 40px;
        margin-right: 12px;
        border-radius: 8px;
    }

    .bookmark-icon {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 1.25rem;
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.3s ease;
        display: none;
    }

    .website-card:hover .bookmark-icon {
        display: block;
    }

    .bookmark-icon:hover, .bookmark-icon.active {
        color: #fbbf24;
    }

    .bookmark-icon.active {
        display: block;
        color: #fbbf24;
    }

    .search-result {
        background-color: #e0f2fe;
        border-radius: 20px;
        padding: 10px 20px;
        font-weight: 600;
        color: #0369a1;
        margin-bottom: 20px;
    }

    .visit-site-btn {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background-color: #f3f4f6;
        border-radius: 20px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        position: absolute;
        right: 16px;
        bottom: 16px;
    }

    .visit-site-btn:hover {
        background-color: #8352f5;
        color: white;
    }
</style>
<body class="bg-gray-100">
<!-- 메뉴바 fragment 사용 -->
<nav th:replace="~{fragment/navbar :: copy}"></nav>

<!-- 사이드바 fragment 사용 -->
<aside th:replace="~{fragment/sidebar :: copy}"></aside>

<!-- 로그인된 경우 북마크 전체 조회 -->
<span sec:authorize="isAuthenticated()">
    <script th:inline="javascript">
        window.onload = function() {
            window.memberId = [[${#authentication.principal.memberId}]];
            findAllBookmark(memberId);
        };
    </script>
</span>

<!--
// v0 by Vercel.
// https://v0.dev/t/LZF12cpgYcS
-->

<!-- 메인 컨덴트 -->
<main class="flex flex-col flex-1 overflow-hidden" style="margin-left: 223px; margin-top: 64px;">
    <div class="mainContainer mx-auto px-4 py-8" style="padding-left: 100px;padding-right: 100px; padding-top: 10px;">

        <!-- 카테고리 바 -->
        <div class="container mx-auto px-40 sm:px-0 md:px-0 xl:px-64 py-16 " style="padding-top: 20px;">
            <div class="flex items-center justify-between py-4 ">
                <div class="flex items-center gap-2 p-2 bg-white shadow-lg rounded-xl">
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=All">All</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=Development">Development</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=Design">Design</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=AI">AI</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=Icon">Icon</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=PPT">PPT</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=Font">Font</a>
                    <a class="category-btn px-4 py-1 rounded-full text-sm font-semibold transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" href="?category=Util">Util</a>
                </div>


                <!-- 검색 결과 개수 표시 -->
                <div class="text-sm text-gray-600 flex items-center justify-center mt-4">
                <span th:if="${resultCount}">
                    <span class="bg-gray-200 rounded-full px-4 py-1 font-semibold text-gray-700">
                        검색 결과: <span class="font-bold text-base" th:text="${resultCount}">0</span>개
                    </span>
                </span>
                </div>
            </div>
        </div>

            <script>
                // 카테고리에 맞게 버튼 색깔 활성화
                document.addEventListener('DOMContentLoaded', function() {
                    const params = new URLSearchParams(window.location.search);
                    const category = params.get('category') || 'All'; // query parameter가 없으면 'All'로 설정
                    const buttons = document.querySelectorAll('.category-btn'); // 카테고리에 맞는 버튼에 active-category 클래스를 추가

                    buttons.forEach(button => {
                        const href = button.getAttribute('href');
                        if ((href.includes('?category=' + category))) {
                            button.classList.add('active-category', 'bg-indigo-500', 'text-white');
                            button.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                        } else {
                            button.classList.remove('active-category', 'bg-indigo-500', 'text-white');
                            button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                        }
                    });
                });
            </script>



            <!-- 검색 결과 없을 때 메시지 표시 -->
            <div th:if="${resultCount != null && resultCount == 0}" class="flex items-center justify-center mt-32">
                <div class="text-center bg-white p-8 rounded-xl shadow-md border border-gray-100">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-16 h-16 flex items-center justify-center rounded-full bg-gray-200">
                            <span class="text-4xl text-gray-400">!</span>
                        </div>
                    </div>
                    <div class="text-2xl font-semibold text-gray-600 mb-2">
                        "<span th:text="${query}"></span>"에 대한 검색 결과가 없습니다.
                    </div>
                    <div class="text-gray-500 text-sm mt-4">
                        다시 검색해주세요.
                    </div>
                </div>
            </div>


            <!-- 검색 결과 있을 때 메시지 표시 -->
            <!-- 웹사이트 요소 -->
            <div class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 mt-4">
                <div th:each="l : ${list}" th:data-website-id="${l.websiteId}" class="website-card relative">
                    <div class="website-card-header">
                        <!-- 웹사이트 이미지 -->
                        <img th:src="@{|https://www.google.com/s2/favicons?sz=48&domain_url=${l.url}|}" alt="" class="website-icon">
                        <!-- 웹사이트 이름 -->
                        <h3 class="text-lg font-semibold" th:text="${l.name}">Website Name</h3>
                        <!-- 북마크(즐겨찾기) -->
                        <i class="bookmark-icon fas fa-bookmark" th:onclick="|Bookmark(${l.websiteId})|"></i>
                    </div>
                    <div class="website-card-body">
                        <!-- 웹사이트 설명 -->
                        <p class="text-xs text-gray-600" th:text="${l.description}">Website Description</p>
                        <a th:href="${l.url}" target="_blank" class="visit-site-btn">
                            <i class="fas fa-external-link-alt mr-1"></i>Visit
                        </a>
                    </div>
                </div>
            </div>
        </div>
</main>

<script th:inline="javascript">

    /**
     *  북마크 전체 조회
     */
    function findAllBookmark(memberId) {

        // API 호출
        callBookmarkApi_sync("/mainList/" + memberId + "/bookmarks", 'GET')
            .then(response => {
                if (!response.length) {
                    return false;
                }
                // 사용자가 북마크한 웹사이트의 ID 목록 생성
                const bookmarkedWebsiteIds = response.map(item => item.website_websiteId);

                document.querySelectorAll('.website-card').forEach(card => {
                    const websiteId = card.getAttribute('data-website-id');
                    const bookmarkIcon = card.querySelector('.bookmark-icon');

                    if (bookmarkedWebsiteIds.includes(parseInt(websiteId))) {
                        bookmarkIcon.classList.add('active');
                    } else {
                        bookmarkIcon.classList.remove('active');
                    }
                });
            })
            .catch(error => {
                console.error("오류 발생:", error);
            });
    }



        // 북마크 API 호출(Synchronous, 동기)
        function callBookmarkApi_sync(uri, method) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: uri,
                    type: method,
                    dataType: 'json',
                    async: false,
                    success: function(response) {
                        resolve(response);
                    },
                    error: function(xhr, status, error) { //xhr :XMLHttpRequest(XHR)
                        if (xhr.status === 401) { // 401 Unauthorized: 로그인되지 않은 경우
                            // 로그인 페이지로 리다이렉션
                            window.location.href = "/login";
                        } else {
                            // 다른 오류 발생 시 처리
                            console.error("오류 발생: " + error);
                        }
                        reject(error);
                    }
                });
            });
        }




        /**
         *  북마크 추가/제거(비동기)
         */
        async function Bookmark(websiteId) {
            // 사용자가 북마크 했는지 안 했는지 체크
            const uri = "/mainList/bookmark/status/" + websiteId; // 서버에 해당 아이템이 북마크되어 있는지 확인하는 요청
            const response = await callBookmarkApi_sync(uri, 'GET');

            const bookmarkIcon = document.querySelector(`[data-website-id="${websiteId}"] .bookmark-icon`);

            // 북마크 하지 않았다면 북마크 추가, 이미 북마크 했다면 북마크 삭제
            if (response == 0) {
                // 북마크 추가
                const uri = "/mainList/" + memberId + "/bookmark/" + websiteId;
                await callBookmarkApi_sync(uri, 'POST');
                bookmarkIcon.classList.add('active');
            } else {
                // 북마크 삭제
                const uri = "/mainList/" + memberId + "/bookmark/" + websiteId;
                await callBookmarkApi_sync(uri, 'DELETE');
                bookmarkIcon.classList.remove('active');
            }
        }
</script>



</div>
</body>
</html>